{% extends "planner/base_planner.html" %}
{% block content %}
<style>
    /* Smooth transitions for overdue visuals */
    .overdue-row {
        position: relative;
        overflow: hidden;
    }

    /* Red → transparent gradient overlay that grows from the RIGHT edge */
    .overdue-row::before {
        content: "";
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        width: calc(var(--overdue, 0) * 100%);
        /* 0..1 → 0..100% */
        /* Strong red on the very right, fading to transparent so text on the left stays readable */
        background: linear-gradient(to left,
                rgba(220, 53, 69, 0.95) 0%,
                rgba(220, 53, 69, 0.95) 10%,
                rgba(220, 53, 69, 0.0) 100%);
        pointer-events: none;
        transition: width 0.25s linear;
    }

    /* Keep the overdue overlay under the content */
    .agenda-row {
        position: relative;
        overflow: hidden;
    }

    .agenda-row::before {
        z-index: 0;
    }

    .agenda-row>* {
        position: relative;
        z-index: 1;
    }

    /* Right rail: fixed width so controls don't drift */
    .agenda-actions {
        min-width: 96px;
        /* enough for checkbox + icon */
        justify-content: flex-end;
    }

    /* Nicer checkbox */
    .modern-check {
        appearance: none;
        -webkit-appearance: none;
        position: relative;
        width: 22px;
        height: 22px;
        border: 2px solid #c7ccd1;
        border-radius: 6px;
        background: #fff;
        cursor: pointer;
        transition: all .15s ease;
        display: inline-flex;
        /* ✅ keeps it aligned in flex containers */
        align-items: center;
        /* ✅ vertical centering */
        justify-content: center;
        /* ✅ horizontal centering */
        vertical-align: middle;
    }



    .modern-check:hover {
        border-color: #9aa4ad;
    }

    .modern-check:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(13, 110, 253, .15);
    }

    .modern-check:checked {
        border-color: #198754;
        background: #198754;
    }

    /* Proper checkmark */
    .modern-check:checked::after {
        content: "";
        position: absolute;
        width: 6px;
        height: 12px;
        border: solid #fff;
        border-width: 0 2px 2px 0;
        transform: rotate(45deg);
        top: 2px;
        /* ✅ moved up a bit */
        left: 6px;
        /* ✅ nudged right */
    }


    /* Compact square icon button */
    .btn-icon {
        --size: 34px;
        width: var(--size);
        height: var(--size);
        padding: 0;
        line-height: 1;
        border-radius: 8px;
        border: 1px solid #dcdfe3;
        background: #fff;
        color: #6b7280;
        transition: background .15s, border-color .15s, color .15s;
    }

    .btn-icon:hover {
        background: #f5f7fb;
        border-color: #c9ced4;
        color: #374151;
    }

    .btn-icon:active {
        background: #eef1f6;
    }
</style>



<div class="d-flex align-items-center justify-content-between mb-3">
    <h4 class="mb-0">Agenda — {{ date }}</h4>
    <a class="btn btn-outline-secondary btn-sm" href="/agenda">Jump to today</a>
</div>

{% if not plan or not items %}
<div class="text-center py-5">
    <p class="lead mb-3">No agenda yet for today.</p>
    <a href="/agenda/edit/" class="btn btn-primary btn-lg">Create today’s agenda</a>
</div>
{% else %}
<ul class="list-group shadow-sm" id="agendaList" data-date="{{ date|date:'Y-m-d' }}">

    {% for it in items %}
    <li id="item-{{ it.id }}" class="list-group-item agenda-row d-flex align-items-center" data-end="{{ it.end_hhmm }}"
        data-done="{% if it.done %}1{% else %}0{% endif %}">
        <div class="agenda-main flex-grow-1 {% if it.done %}text-decoration-line-through text-muted{% endif %}">
            <span class="fw-semibold">{{ it.start_hhmm }}–{{ it.end_hhmm }}</span>
            &nbsp; <span class="text-muted">[{{ it.group_name|default:it.task.group.name }}]</span>
            {{ it.task.title }}
        </div>

        <div class="agenda-actions d-flex align-items-center gap-2">
            <form method="post" action="{% url 'planner:toggle-done' it.id %}" class="m-0 p-0">
                {% csrf_token %}
                <input type="checkbox" class="modern-check" {% if it.done %}checked{% endif %}
                    onchange="this.form.submit()">
            </form>

            <button type="button" class="btn btn-icon" data-bs-toggle="modal" data-bs-target="#delayModal"
                data-item-id="{{ it.id }}" title="Delay this task">
                ⏱
            </button>
        </div>
    </li>

    {% endfor %}
</ul>

<!-- Delay Modal -->
<div class="modal fade" id="delayModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form method="post" id="delayForm">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title">Delay Task</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <p class="mb-3">How much time do you want to extend this task (and push later ones)?</p>
                    <input type="hidden" name="minutes" id="delayMinutes">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-warning delay-btn" data-min="15">+15m</button>
                        <button type="button" class="btn btn-outline-warning delay-btn" data-min="30">+30m</button>
                        <button type="button" class="btn btn-outline-warning delay-btn" data-min="60">+1h</button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>


{% endif %}

<div class="fab-stack">
    <a class="btn btn-primary fab" title="Edit" href="/agenda/edit/">✎</a>
    <a class="btn btn-success fab" title="Add" href="/agenda/add/">＋</a>
    <a class="btn btn-secondary fab" title="Manage" href="/agenda/manage/">☰</a>
</div>

<script>
    (function () {
        const listEl = document.getElementById('agendaList');
        if (!listEl) { console.log('[overdue] no agendaList'); return; }

        function parseISODate(dstr) {
            const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(dstr || '');
            if (!m) return null;
            const y = +m[1], mo = +m[2], d = +m[3];
            return new Date(y, mo - 1, d, 0, 0, 0, 0);
        }
        function parseHHMM(s) {
            const m = /^(\d{2}):(\d{2})$/.exec(s || '');
            if (!m) return null;
            const h = +m[1], mi = +m[2];
            if (h < 0 || h > 24 || mi < 0 || mi > 59) return null;
            return h * 60 + mi;
        }

        const DAY_MIN = 24 * 60;

        function updateOverdue() {
            const pageDateISO = listEl.getAttribute('data-date'); // should be Y-m-d
            const baseDate = parseISODate(pageDateISO);
            console.log('[overdue] page date:', pageDateISO, '->', baseDate?.toString());

            const now = new Date();
            const items = listEl.querySelectorAll('li[data-end]');
            console.log('[overdue] items found:', items.length, 'now:', now.toString());

            items.forEach(li => {
                // ensure class present
                li.classList.add('overdue-row');
                // reset CSS var each pass
                li.style.setProperty('--overdue', 0);

                const done = li.getAttribute('data-done') === '1';
                const endStr = li.getAttribute('data-end');
                const endMin = parseHHMM(endStr);

                if (done) { return; }
                if (endMin == null || !baseDate) { console.log('[overdue] bad time/date for', li.id, endStr, baseDate); return; }

                const endDate = new Date(baseDate);
                endDate.setMinutes(endMin);
                const overdueMs = now - endDate;
                if (overdueMs <= 0) return; // not overdue

                const overdueMin = Math.floor(overdueMs / 60000);
                const t = Math.max(0, Math.min(1, overdueMin / DAY_MIN)); // 0..1 over 24h
                li.style.setProperty('--overdue', t.toFixed(3));
            });
        }

        updateOverdue();
        setInterval(updateOverdue, 60 * 1000);
    })();
</script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const delayModal = document.getElementById('delayModal');
        const delayForm = document.getElementById('delayForm');
        const minutesInput = document.getElementById('delayMinutes');

        // when modal opens, set action to the right item
        delayModal.addEventListener('show.bs.modal', event => {
            const button = event.relatedTarget; // the ⏱ trigger
            const itemId = button.getAttribute('data-item-id');
            delayForm.action = `/agenda/item/${itemId}/delay/`;  // matches urls.py
            minutesInput.value = ""; // reset
        });

        // hook buttons inside modal
        document.querySelectorAll('.delay-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                minutesInput.value = btn.getAttribute('data-min');
                delayForm.submit(); // submit with chosen delay
            });
        });
    });
</script>


{% endblock %}