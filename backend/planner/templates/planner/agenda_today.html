{% extends "planner/base_planner.html" %}
{% block content %}
<style>
    /* Smooth transitions for overdue visuals */
    .overdue-row {
        position: relative;
        overflow: hidden;
    }

    /* Red → transparent gradient overlay that grows from the RIGHT edge */
    .overdue-row::before {
        content: "";
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        width: calc(var(--overdue, 0) * 100%);
        /* 0..1 → 0..100% */
        /* Strong red on the very right, fading to transparent so text on the left stays readable */
        background: linear-gradient(to left,
                rgba(220, 53, 69, 0.95) 0%,
                rgba(220, 53, 69, 0.95) 10%,
                rgba(220, 53, 69, 0.0) 100%);
        pointer-events: none;
        transition: width 0.25s linear;
    }

    /* Keep the overdue overlay under the content */
    .agenda-row {
        position: relative;
        overflow: hidden;
    }

    .agenda-row::before {
        z-index: 0;
    }

    .agenda-row>* {
        position: relative;
        z-index: 1;
    }

    /* Right rail: fixed width so controls don't drift */
    .agenda-actions {
        min-width: 96px;
        /* enough for checkbox + icon */
        justify-content: flex-end;
    }

    /* Nicer checkbox */
    .modern-check {
        appearance: none;
        -webkit-appearance: none;
        position: relative;
        width: 22px;
        height: 22px;
        border: 2px solid #c7ccd1;
        border-radius: 6px;
        background: #fff;
        cursor: pointer;
        transition: all .15s ease;
        display: inline-flex;
        /* ✅ keeps it aligned in flex containers */
        align-items: center;
        /* ✅ vertical centering */
        justify-content: center;
        /* ✅ horizontal centering */
        vertical-align: middle;
    }



    .modern-check:hover {
        border-color: #9aa4ad;
    }

    .modern-check:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(13, 110, 253, .15);
    }

    .modern-check:checked {
        border-color: #198754;
        background: #198754;
    }

    /* Proper checkmark */
    .modern-check:checked::after {
        content: "";
        position: absolute;
        width: 6px;
        height: 12px;
        border: solid #fff;
        border-width: 0 2px 2px 0;
        transform: rotate(45deg);
        top: 2px;
        /* ✅ moved up a bit */
        left: 6px;
        /* ✅ nudged right */
    }


    /* Compact square icon button */
    .btn-icon {
        --size: 34px;
        width: var(--size);
        height: var(--size);
        padding: 0;
        line-height: 1;
        border-radius: 8px;
        border: 1px solid #dcdfe3;
        background: #fff;
        color: #6b7280;
        transition: background .15s, border-color .15s, color .15s;
    }

    .btn-icon:hover {
        background: #f5f7fb;
        border-color: #c9ced4;
        color: #374151;
    }

    .btn-icon:active {
        background: #eef1f6;
    }

    .white-space-prewrap {
        white-space: pre-wrap;
    }

    .task-toggle {
        background: none;
        border: 0;
        padding: 0;
        margin: 0;
        color: inherit;
        /* keep original text color */
        font: inherit;
        /* keep font same as parent */
        text-decoration: none;
        /* remove underline */
        cursor: pointer;
    }

    .task-toggle:hover,
    .task-toggle:focus {
        text-decoration: none;
        /* prevent underline on hover/focus */
        color: inherit;
        /* stay black even when hovered */
    }
</style>

<style>
    .draw-canvas {
        touch-action: none;
    }

    /* better touch drawing */
</style>



<div class="d-flex align-items-center justify-content-between mb-3">
    <h4 class="mb-0">Agenda — {{ date }}</h4>
    <a class="btn btn-outline-secondary btn-sm" href="/agenda">Jump to today</a>
</div>

{% if not plan or not items %}
<div class="text-center py-5">
    <p class="lead mb-3">No agenda yet for today.</p>
    <a href="/agenda/edit/" class="btn btn-primary btn-lg">Create today’s agenda</a>
</div>
{% else %}
<ul class="list-group shadow-sm" id="agendaList" data-date="{{ date|date:'Y-m-d' }}">

    {% for it in items %}
    <li id="item-{{ it.id }}" class="list-group-item agenda-row d-flex align-items-center"
        data-start="{{ it.start_hhmm }}" data-end="{{ it.end_hhmm }}"
        data-done="{% if it.done %}1{% else %}0{% endif %}">
        <div class="agenda-main flex-grow-1 {% if it.done %}text-decoration-line-through text-muted{% endif %}">

            <button type="button" class="task-toggle w-100 text-start" data-bs-toggle="collapse"
                data-bs-target="#desc-{{ it.id }}" aria-expanded="false">
                <span class="fw-semibold">{{ it.start_hhmm }}–{{ it.end_hhmm }}</span>
                &nbsp; <span class="text-muted">[{{ it.group_name|default:it.task.group.name }}]</span>
                {{ it.task.title }}
            </button>

            <!-- Collapsible description area -->
            <div id="desc-{{ it.id }}" class="collapse mt-2">
                {% if it.task.description_type == "text" and it.task.description_text %}
                <div class="small text-muted white-space-prewrap">{{ it.task.description_text }}</div>

                {% elif it.task.description_type == "check" %}
                <ul class="list-unstyled mb-2" id="cl-{{ it.task.id }}">
                    {% for ci in it.task.check_items.all %}
                    <li class="d-flex align-items-center gap-2 py-1" data-item-id="{{ ci.id }}">
                        <input type="checkbox" class="form-check-input cl-toggle" {% if ci.done %}checked{% endif %}>
                        <span class="flex-grow-1 {% if ci.done %}text-decoration-line-through text-muted{% endif %}">
                            {{ ci.text }}
                        </span>
                        <button class="btn btn-sm btn-outline-danger cl-del" title="Delete">✕</button>
                    </li>
                    {% empty %}
                    <li class="text-muted small">No checklist items yet.</li>
                    {% endfor %}
                </ul>
                <form class="d-flex gap-2 cl-add-form" data-task-id="{{ it.task.id }}">
                    {% csrf_token %}
                    <input class="form-control form-control-sm" name="text" placeholder="Add item…">
                    <button class="btn btn-sm btn-outline-primary">Add</button>
                </form>

                {% elif it.task.description_type == "scribble" %}
                <hr class="my-2">
                <div class="d-flex align-items-center justify-content-between mb-2">
                    <div class="fw-semibold">Scribbles</div>
                    <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal"
                        data-bs-target="#drawModal" data-task-id="{{ it.task.id }}"
                        data-task-title="{{ it.task.title }}">
                        New drawing
                    </button>
                </div>

                <!-- Thumbnails -->
                <div class="d-flex gap-2 flex-wrap" id="draw-thumbs-{{ it.task.id }}">
                    {% for dr in it.task.drawings.all %}
                    <div class="position-relative" data-drawing-id="{{ dr.id }}">
                        <a href="{{ dr.image.url }}" target="_blank" title="{{ dr.title|default:'Drawing' }}">
                            <img src="{{ dr.image.url }}" alt=""
                                style="width:120px;height:auto;border-radius:6px;border:1px solid #e5e7eb;">
                        </a>
                        <button class="btn btn-sm btn-light position-absolute top-0 end-0 draw-del"
                            data-drawing-id="{{ dr.id }}" title="Delete">✕</button>
                    </div>
                    {% empty %}
                    <div class="text-muted small">No drawings yet.</div>
                    {% endfor %}
                </div>

                {% else %}
                <div class="small text-muted">No description.</div>
                {% endif %}
            </div>
        </div>

        <div class="agenda-actions d-flex align-items-center gap-2">
            <form method="post" action="{% url 'planner:toggle-done' it.id %}" class="m-0 p-0">
                {% csrf_token %}
                <input type="checkbox" class="modern-check" {% if it.done %}checked{% endif %}
                    onchange="this.form.submit()">
            </form>

            <button type="button" class="btn btn-icon" data-bs-toggle="modal" data-bs-target="#delayModal"
                data-item-id="{{ it.id }}" title="Delay this task">
                ⏱
            </button>
        </div>
    </li>

    {% endfor %}
</ul>

<!-- Drawing modal -->
<div class="modal fade" id="drawModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    New drawing — <span id="drawTaskTitle">Task</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex align-items-center gap-2 mb-2">
                    <label class="form-label mb-0">Color</label>
                    <input type="color" id="penColor" value="#1f2937">
                    <label class="form-label mb-0 ms-3">Size</label>
                    <input type="range" id="penSize" min="1" max="28" value="5" style="width:140px">
                    <button class="btn btn-sm btn-outline-secondary" id="eraserBtn" type="button">Eraser</button>
                    <button class="btn btn-sm btn-outline-secondary" id="undoBtn" type="button">Undo</button>
                    <button class="btn btn-sm btn-outline-danger ms-auto" id="clearBtn" type="button">Clear</button>
                </div>
                <div class="border rounded" style="overflow:hidden">
                    <canvas id="drawCanvas" class="draw-canvas"
                        style="width:100%;height:360px;background:#fff;"></canvas>
                </div>
                <div class="mt-2">
                    <input type="text" class="form-control form-control-sm" id="drawTitle"
                        placeholder="Optional title…">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button class="btn btn-primary" id="saveDrawingBtn">Save</button>
            </div>
        </div>
    </div>
</div>


<!-- Delay Modal -->
<div class="modal fade" id="delayModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form method="post" id="delayForm">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title">Delay Task</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <p class="mb-3">How much time do you want to extend this task (and push later ones)?</p>
                    <input type="hidden" name="minutes" id="delayMinutes">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-warning delay-btn" data-min="15">+15m</button>
                        <button type="button" class="btn btn-outline-warning delay-btn" data-min="30">+30m</button>
                        <button type="button" class="btn btn-outline-warning delay-btn" data-min="60">+1h</button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>


{% endif %}

<div class="fab-stack">
    <a class="btn btn-info fab" id="freeTimeFab" data-bs-toggle="modal" data-bs-target="#freeTimeModal"
        title="Unallocated hours">
        <span id="freeTotalFab">—</span>
    </a>

    <a class="btn btn-primary fab" title="Edit" href="/agenda/edit/">✎</a>
    <a class="btn btn-success fab" title="Add" href="/agenda/add/">＋</a>
    <a class="btn btn-secondary fab" title="Manage" href="/agenda/manage/">☰</a>
</div>


<!-- Free time modal -->
<div class="modal fade" id="freeTimeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Unallocated time — <span id="freeTotalTitle">—</span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-sm align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Time range</th>
                                <th class="text-end">Minutes</th>
                            </tr>
                        </thead>
                        <tbody id="freeSlotsBody">
                            <!-- rows injected by JS -->
                        </tbody>
                    </table>
                </div>
                <div class="small text-muted mt-2">Gaps are within 00:00–24:00 based on today’s agenda.</div>
            </div>
            <div class="modal-footer">
                <a href="/agenda/edit/" class="btn btn-primary">Open editor</a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
    (function () {
        const listEl = document.getElementById('agendaList');
        if (!listEl) { console.log('[overdue] no agendaList'); return; }

        function parseISODate(dstr) {
            const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(dstr || '');
            if (!m) return null;
            const y = +m[1], mo = +m[2], d = +m[3];
            return new Date(y, mo - 1, d, 0, 0, 0, 0);
        }
        function parseHHMM(s) {
            const m = /^(\d{2}):(\d{2})$/.exec(s || '');
            if (!m) return null;
            const h = +m[1], mi = +m[2];
            if (h < 0 || h > 24 || mi < 0 || mi > 59) return null;
            return h * 60 + mi;
        }

        const DAY_MIN = 24 * 60;

        function updateOverdue() {
            const pageDateISO = listEl.getAttribute('data-date'); // should be Y-m-d
            const baseDate = parseISODate(pageDateISO);
            console.log('[overdue] page date:', pageDateISO, '->', baseDate?.toString());

            const now = new Date();
            const items = listEl.querySelectorAll('li[data-end]');
            console.log('[overdue] items found:', items.length, 'now:', now.toString());

            items.forEach(li => {
                // ensure class present
                li.classList.add('overdue-row');
                // reset CSS var each pass
                li.style.setProperty('--overdue', 0);

                const done = li.getAttribute('data-done') === '1';
                const endStr = li.getAttribute('data-end');
                const endMin = parseHHMM(endStr);

                if (done) { return; }
                if (endMin == null || !baseDate) { console.log('[overdue] bad time/date for', li.id, endStr, baseDate); return; }

                const endDate = new Date(baseDate);
                endDate.setMinutes(endMin);
                const overdueMs = now - endDate;
                if (overdueMs <= 0) return; // not overdue

                const overdueMin = Math.floor(overdueMs / 60000);
                const t = Math.max(0, Math.min(1, overdueMin / DAY_MIN)); // 0..1 over 24h
                li.style.setProperty('--overdue', t.toFixed(3));
            });
        }

        updateOverdue();
        setInterval(updateOverdue, 60 * 1000);
    })();
</script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const delayModal = document.getElementById('delayModal');
        const delayForm = document.getElementById('delayForm');
        const minutesInput = document.getElementById('delayMinutes');

        // when modal opens, set action to the right item
        delayModal.addEventListener('show.bs.modal', event => {
            const button = event.relatedTarget; // the ⏱ trigger
            const itemId = button.getAttribute('data-item-id');
            delayForm.action = `/agenda/item/${itemId}/delay/`;  // matches urls.py
            minutesInput.value = ""; // reset
        });

        // hook buttons inside modal
        document.querySelectorAll('.delay-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                minutesInput.value = btn.getAttribute('data-min');
                delayForm.submit(); // submit with chosen delay
            });
        });
    });
</script>

<script>
    (function () {
        const list = document.getElementById('agendaList');      // required
        const fabSpan = document.getElementById('freeTotalFab');    // the number inside the round FAB
        const totalTitle = document.getElementById('freeTotalTitle');  // modal title number (optional)
        const body = document.getElementById('freeSlotsBody');   // modal table body (optional)

        if (!list) return; // don't require the old button anymore

        const DAY_MIN = 24 * 60;
        const toMin = (hhmm) => {
            const m = /^(\d{2}):(\d{2})$/.exec(hhmm || '');
            if (!m) return null; const h = +m[1], mi = +m[2]; return h * 60 + mi;
        };
        const fmt = (m) => `${String(Math.floor(m / 60)).padStart(2, '0')}:${String(m % 60).padStart(2, '0')}`;

        function getBusyIntervals() {
            const rows = Array.from(list.querySelectorAll('li[data-start][data-end]'));
            let intervals = rows.map(li => {
                const s = toMin(li.getAttribute('data-start'));
                const e = toMin(li.getAttribute('data-end'));
                return (s == null || e == null) ? null : [Math.max(0, s), Math.min(DAY_MIN, e)];
            }).filter(Boolean);
            intervals.sort((a, b) => a[0] - b[0] || a[1] - b[1]);
            const merged = [];
            for (const iv of intervals) {
                if (!merged.length || iv[0] > merged[merged.length - 1][1]) merged.push(iv.slice());
                else merged[merged.length - 1][1] = Math.max(merged[merged.length - 1][1], iv[1]);
            }
            return merged;
        }

        function computeGaps() {
            const busy = getBusyIntervals();
            const gaps = [];
            let cursor = 0;
            for (const [s, e] of busy) {
                if (s > cursor) {
                    const dur = s - cursor;
                    if (dur >= 15) {          // ✅ only include gaps >= 15 min
                        gaps.push([cursor, s]);
                    }
                }
                cursor = Math.max(cursor, e);
            }
            if (cursor < DAY_MIN) {
                const dur = DAY_MIN - cursor;
                if (dur >= 15) {            // ✅ only include if >= 15 min
                    gaps.push([cursor, DAY_MIN]);
                }
            }
            return gaps;
        }


        function render() {
            const gaps = computeGaps();
            const total = gaps.reduce((acc, [s, e]) => acc + (e - s), 0);
            const hrs = total / 60;
            const totalText = hrs.toFixed(1).replace(/\.0$/, ''); // "9.8" or "6"

            // ✅ update the FAB number
            if (fabSpan) fabSpan.textContent = totalText;

            // ✅ optional: update modal title
            if (totalTitle) totalTitle.textContent = `${hrs.toFixed(1)}h`;

            // ✅ optional: fill modal table (only if modal exists)
            if (body) {
                body.innerHTML = '';
                if (!gaps.length) {
                    body.innerHTML = `<tr><td colspan="2" class="text-center text-muted py-3">No unallocated time 🎉</td></tr>`;
                } else {
                    for (const [s, e] of gaps) {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `<td>${fmt(s)}–${fmt(e)}</td><td class="text-end">${e - s}</td>`;
                        tr.style.cursor = 'pointer';
                        tr.title = 'Open editor';
                        tr.addEventListener('click', () => window.location.href = '/agenda/edit/');
                        body.appendChild(tr);
                    }
                }
            }
        }

        render();
    })();
</script>



<script>
    (function () {
        // Add item
        document.querySelectorAll('.cl-add-form').forEach(form => {
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const taskId = form.getAttribute('data-task-id');
                const input = form.querySelector('input[name="text"]');
                const text = (input.value || "").trim();
                if (!text) return;
                const resp = await fetch(`/agenda/task/${taskId}/check/add/`, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value },
                    body: new URLSearchParams({ text })
                });
                const data = await resp.json();
                if (!data.ok) return alert(data.error || 'Error');
                // inject row
                const ul = document.getElementById(`cl-${taskId}`);
                const li = document.createElement('li');
                li.className = 'd-flex align-items-center gap-2 py-1';
                li.setAttribute('data-item-id', data.id);
                li.innerHTML = `
        <input type="checkbox" class="form-check-input cl-toggle">
        <span class="flex-grow-1">${data.text}</span>
        <button class="btn btn-sm btn-outline-danger cl-del" title="Delete">✕</button>`;
                ul.appendChild(li);
                input.value = "";
            });
        });

        // Toggle + Delete via event delegation
        document.querySelectorAll('ul[id^="cl-"]').forEach(ul => {
            ul.addEventListener('click', async (e) => {
                const li = e.target.closest('li[data-item-id]');
                if (!li) return;
                const taskId = ul.id.split('-')[1];
                const itemId = li.getAttribute('data-item-id');

                // Toggle
                if (e.target.classList.contains('cl-toggle')) {
                    const form = ul.parentElement.querySelector('.cl-add-form');
                    const resp = await fetch(`/agenda/task/${taskId}/check/toggle/${itemId}/`, {
                        method: 'POST', headers: { 'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value }
                    });
                    const data = await resp.json();
                    if (!data.ok) { e.target.checked = !e.target.checked; return; }
                    const span = li.querySelector('span.flex-grow-1');
                    span.classList.toggle('text-decoration-line-through', data.done);
                    span.classList.toggle('text-muted', data.done);
                }

                // Delete
                if (e.target.classList.contains('cl-del')) {
                    const form = ul.parentElement.querySelector('.cl-add-form');
                    const resp = await fetch(`/agenda/task/${taskId}/check/delete/${itemId}/`, {
                        method: 'POST', headers: { 'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value }
                    });
                    const data = await resp.json();
                    if (data.ok) li.remove();
                }
            });
        });
    })();
</script>


<script>
    (function () {
        // --------- modal wiring ----------
        let activeTaskId = null;
        const modal = document.getElementById('drawModal');
        const titleSpan = document.getElementById('drawTaskTitle');
        const canvas = document.getElementById('drawCanvas');
        const ctx = canvas.getContext('2d');
        const penColor = document.getElementById('penColor');
        const penSize = document.getElementById('penSize');
        const eraserBtn = document.getElementById('eraserBtn');
        const undoBtn = document.getElementById('undoBtn');
        const clearBtn = document.getElementById('clearBtn');
        const saveBtn = document.getElementById('saveDrawingBtn');
        const titleInp = document.getElementById('drawTitle');

        // high-DPI sizing
        function sizeCanvas() {
            const rect = canvas.getBoundingClientRect();
            const ratio = window.devicePixelRatio || 1;
            canvas.width = Math.round(rect.width * ratio);
            canvas.height = Math.round(rect.height * ratio);
            ctx.scale(ratio, ratio);
            ctx.fillStyle = "#ffffff";
            ctx.fillRect(0, 0, rect.width, rect.height);
        }
        sizeCanvas();
        window.addEventListener('resize', sizeCanvas);

        // strokes stack for undo
        let drawing = false;
        let last = null;
        let strokes = []; // each stroke = {points:[{x,y}], color, size, erase}

        function startDraw(x, y) {
            drawing = true;
            last = { x, y };
            strokes.push({ points: [{ x, y }], color: penColor.value, size: parseInt(penSize.value, 10), erase: eraserBtn.classList.contains('active') });
        }
        function drawTo(x, y) {
            if (!drawing) return;
            const s = strokes[strokes.length - 1];
            s.points.push({ x, y });
            ctx.lineJoin = ctx.lineCap = 'round';
            ctx.lineWidth = s.size;
            if (s.erase) {
                ctx.globalCompositeOperation = 'destination-out';
                ctx.strokeStyle = 'rgba(0,0,0,1)';
            } else {
                ctx.globalCompositeOperation = 'source-over';
                ctx.strokeStyle = s.color;
            }
            ctx.beginPath();
            ctx.moveTo(last.x, last.y);
            ctx.lineTo(x, y);
            ctx.stroke();
            last = { x, y };
        }
        function endDraw() { drawing = false; last = null; }

        function getPos(e) {
            const r = canvas.getBoundingClientRect();
            if (e.touches && e.touches[0]) {
                return { x: e.touches[0].clientX - r.left, y: e.touches[0].clientY - r.top };
            }
            return { x: e.clientX - r.left, y: e.clientY - r.top };
        }

        canvas.addEventListener('mousedown', e => startDraw(...Object.values(getPos(e))));
        canvas.addEventListener('mousemove', e => drawTo(...Object.values(getPos(e))));
        window.addEventListener('mouseup', endDraw);
        canvas.addEventListener('touchstart', e => { e.preventDefault(); startDraw(...Object.values(getPos(e))); });
        canvas.addEventListener('touchmove', e => { e.preventDefault(); drawTo(...Object.values(getPos(e))); });
        canvas.addEventListener('touchend', e => { e.preventDefault(); endDraw(); });

        eraserBtn.addEventListener('click', () => eraserBtn.classList.toggle('active'));
        clearBtn.addEventListener('click', () => {
            const rect = canvas.getBoundingClientRect();
            ctx.globalCompositeOperation = 'source-over';
            ctx.fillStyle = "#fff";
            ctx.fillRect(0, 0, rect.width, rect.height);
            strokes = [];
        });
        undoBtn.addEventListener('click', () => {
            if (!strokes.length) return;
            strokes.pop();
            // redraw all
            const rect = canvas.getBoundingClientRect();
            ctx.globalCompositeOperation = 'source-over';
            ctx.fillStyle = "#fff";
            ctx.fillRect(0, 0, rect.width, rect.height);
            for (const s of strokes) {
                ctx.lineJoin = ctx.lineCap = 'round';
                ctx.lineWidth = s.size;
                ctx.globalCompositeOperation = s.erase ? 'destination-out' : 'source-over';
                ctx.strokeStyle = s.erase ? 'rgba(0,0,0,1)' : s.color;
                for (let i = 1; i < s.points.length; i++) {
                    ctx.beginPath();
                    ctx.moveTo(s.points[i - 1].x, s.points[i - 1].y);
                    ctx.lineTo(s.points[i].x, s.points[i].y);
                    ctx.stroke();
                }
            }
        });

        // when opened, set task id/title and reset canvas
        modal.addEventListener('show.bs.modal', (ev) => {
            const btn = ev.relatedTarget;
            activeTaskId = btn.getAttribute('data-task-id');
            titleSpan.textContent = btn.getAttribute('data-task-title') || 'Task';
            titleInp.value = '';
            sizeCanvas();
            strokes = [];
        });

        // save -> POST base64 png to server, then inject thumbnail
        saveBtn.addEventListener('click', async () => {
            if (!activeTaskId) return;
            const dataURL = canvas.toDataURL("image/png");
            const csrf = document.querySelector('input[name=csrfmiddlewaretoken]')?.value; // any token on page
            const resp = await fetch(`/agenda/task/${activeTaskId}/drawing/save/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': csrf },
                body: new URLSearchParams({ png: dataURL, title: titleInp.value || "" })
            });
            const data = await resp.json();
            if (!data.ok) { alert(data.error || 'Save failed'); return; }

            // add thumb
            const wrap = document.getElementById(`draw-thumbs-${activeTaskId}`);
            const block = document.createElement('div');
            block.className = 'position-relative';
            block.setAttribute('data-drawing-id', data.id);
            block.innerHTML = `
      <a href="${data.url}" target="_blank" title="${data.title || 'Drawing'}">
        <img src="${data.url}" style="width:120px;height:auto;border-radius:6px;border:1px solid #e5e7eb;">
      </a>
      <button class="btn btn-sm btn-light position-absolute top-0 end-0 draw-del" data-drawing-id="${data.id}">✕</button>
    `;
            // remove "No drawings yet" hint if present
            if (wrap && wrap.firstElementChild && wrap.firstElementChild.classList.contains('text-muted')) {
                wrap.innerHTML = '';
            }
            wrap?.prepend(block);

            // close modal
            bootstrap.Modal.getInstance(modal)?.hide();
        });

        // delete handler (event delegation across all thumb containers)
        document.querySelectorAll('[id^="draw-thumbs-"]').forEach(g => {
            g.addEventListener('click', async (e) => {
                if (!e.target.classList.contains('draw-del')) return;
                const drawingId = e.target.getAttribute('data-drawing-id');
                const csrf = document.querySelector('input[name=csrfmiddlewaretoken]')?.value;
                const ok = confirm('Delete this drawing?');
                if (!ok) return;
                const r = await fetch(`/agenda/drawing/${drawingId}/delete/`, {
                    method: 'POST', headers: { 'X-CSRFToken': csrf }
                });
                const data = await r.json();
                if (data.ok) e.target.closest('[data-drawing-id]').remove();
            });
        });
    })();
</script>


{% endblock %}